@model IEnumerable<ReviewAggregatorWebApp.Model.Movie>
@{
    var genre = ViewBag.Genre;
    var year = ViewBag.Year;
    var director = ViewBag.Director;
    var country = ViewBag.Country;
    var sortOrder = ViewBag.SortOrder;
    var pageNumber = ViewBag.CurrentPage;

    // Получаем данные для фильтров из кэша
    var genres = ViewBag.Genres;
    var years = ViewBag.Years;
    var directors = ViewBag.Directors;
    var countries = ViewBag.Countries;

    // Формируем заголовок страницы
    string genreTitle = string.IsNullOrEmpty(genre) ? "" : $" жанра {genre}";
    string yearTitle = string.IsNullOrEmpty(year) ? "" : $" {year} года";
    string directorTitle = string.IsNullOrEmpty(director) ? "" : $" режиссера {director}";
    string countryTitle = string.IsNullOrEmpty(country) ? "" : $", созданные в стране {country}";

    Layout = "~/Views/Shared/MainLayout.cshtml";
}

<h1>Фильмы@(genreTitle + yearTitle + directorTitle + countryTitle)</h1>

<div class="filter-section">
    <form method="get" action="@Url.Action("Filter", new { genre = genre, year = year, director = director, country = country, sortBy = sortOrder })">
        <div class="form-group">
            <label for="genre">Жанр:</label>
            <select id="genre" name="genre" class="form-control">
                <option value="">Все</option>
                @foreach (var g in genres)
                {
                    <option value="@g" selected="@(g.ToString() == genre ? "selected" : null)">@g</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label for="year">Год выхода:</label>
            <select id="year" name="year" class="form-control">
                <option value="">Все</option>
                @foreach (var y in years)
                {
                    <option value="@y" selected="@(y.ToString() == year ? "selected" : null)">@y</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label for="director">Режиссер:</label>
            <select id="director" name="director" class="form-control">
                <option value="">Все</option>
                @foreach (var d in directors)
                {
                    <option value="@d" selected="@(d.ToString() == director ? "selected" : null)">@d</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label for="country">Страна:</label>
            <select id="country" name="country" class="form-control">
                <option value="">Все</option>
                @foreach (var c in countries)
                {
                    <option value="@c" selected="@(c.ToString() == country ? "selected" : null)">@c</option>
                }
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Применить фильтр</button>
    </form>
</div>

<div class="form-group">
    <label for="sortOptions">Сортировать по:</label>
    <select id="sortOptions" class="form-control" onchange="location = this.value;">
        <option value="@Url.Action("Filter", new { genra = genre, year = year, director = director, country = country, sortBy = "rating" })" selected="@(sortOrder == "rating" ? "selected" : null)">По рейтингу</option>
        <option value="@Url.Action("Filter", new { genra = genre, year = year, director = director, country = country, sortBy = "date" })" selected="@(sortOrder == "date" ? "selected" : null)">По дате</option>
    </select>
</div>

@if (User.IsInRole("Admin"))
{
    <div>
        <a asp-action="Create" class="btn btn-primary">Добавить фильм</a>
    </div>
}

@if (Model != null && Model.Any())
{
    <ul>
        @foreach (var movie in Model)
        {
            <li class="movie-item">
                <div class="movie-info">
                    <a href="@Url.Action("Details", "MovieInfo", new { id = movie.Id })" class="movie-link">
                        <strong>
                            @movie.Name
                        </strong> - @(movie.ReleaseDate.Year.ToString())
                        <br />
                        Жанры: @string.Join(", ", movie.Genres?.Select(g => g.Name) ?? new List<string> { "-" })
                        <br />
                        Режиссер: @(movie.Director?.Name ?? "–")
                        <br />
                        Страны: @string.Join(", ", movie.Countries?.Select(c => c.Name) ?? new List<string> { "-" })
                    </a>

                    @if (User.IsInRole("Admin"))
                    {
                        <div>
                            <a href="@Url.Action("Edit", new {id = movie.Id})" class="btn btn-secondary">Изменить</a>
                            <button class="btn btn-danger" onclick="confirmDelete(@movie.Id)">Удалить</button>
                        </div>
                    }
                </div>
            </li>
        }
    </ul>
}
else
{
    <p>Фильмы не найдены.</p>
}

<div class="pagination" style="display: flex; justify-content: center; align-items: center;">
    @if (ViewBag.TotalPages > 1)
    {
        // Кнопка "Первая"
        if (ViewBag.CurrentPage > 1)
        {
            <a href="@Url.Action("Filter", new { genre = genre, year = year, director = director, country = country, sortBy = sortOrder, pageNumber = 1 })" class="btn btn-secondary" style="margin: 0 3px;">1</a>
        }

        // Многоточие перед предыдущими страницами
        if (ViewBag.CurrentPage > 3)
        {
            <span style="margin: 0 3px;">...</span>
        }

        // Кнопки для предыдущих страниц
        if (ViewBag.CurrentPage > 2)
        {
            <a href="@Url.Action("Filter", new { genre = genre, year = year, director = director, country = country, sortBy = sortOrder, pageNumber = ViewBag.CurrentPage - 1 })" class="btn btn-secondary" style="margin: 0 3px;">@(ViewBag.CurrentPage - 1)</a>
        }

        // Текущая страница
        <form method="get" class="d-inline-block" style="margin: 0 3px;">
            <input type="hidden" name="genre" value="@genre" />
            <input type="hidden" name="year" value="@year" />
            <input type="hidden" name="director" value="@director" />
            <input type="hidden" name="country" value="@country" />
            <input type="hidden" name="sortBy" value="@sortOrder" />
            <div class="input-group">
                <input type="number" name="pageNumber" min="1" max="@ViewBag.TotalPages" value="@ViewBag.CurrentPage" />
                <button type="submit" class="btn btn-primary">Перейти</button>
            </div>
        </form>

        // Кнопка для следующей страницы
        if (ViewBag.CurrentPage < ViewBag.TotalPages - 1)
        {
            <a href="@Url.Action("Filter", new { genre = genre, year = year, director = director, country = country, sortBy = sortOrder, pageNumber = ViewBag.CurrentPage + 1 })" class="btn btn-secondary" style="margin: 0 3px;">@(ViewBag.CurrentPage + 1)</a>
        }

        // Многоточие после следующих страниц
        if (ViewBag.CurrentPage < ViewBag.TotalPages - 2)
        {
            <span style="margin: 0 3px;">...</span>
        }

        // Кнопка "Последняя"
        if (ViewBag.CurrentPage < ViewBag.TotalPages)
        {
            <a href="@Url.Action("Filter", new { genre = genre, year = year, director = director, country = country, sortBy = sortOrder, pageNumber = ViewBag.TotalPages })" class="btn btn-secondary" style="margin: 0 3px;">@ViewBag.TotalPages</a>
        }
    }
</div>



<script>
    function goToPage() {
        var pageNumber = document.getElementById('currentPage').value;
        var totalPages = @ViewBag.TotalPages;

        if (pageNumber >= 1 && pageNumber <= totalPages) {
            window.location.href = '@Url.Action("Filter", new { genre = genre, year = year, director = director, country = country, sortBy = sortOrder, pageNumber = "__PAGE__" })'.replace('__PAGE__', pageNumber);
        } else {
            alert('Введите корректный номер страницы (от 1 до ' + totalPages + ')');
        }
    }
</script>

<script>
    function confirmDelete(movieId) {
        if (confirm("Вы уверены, что хотите удалить этот фильм?")) {
            window.location.href = '@Url.Action("Delete")/' + movieId;
        }
    }
</script>